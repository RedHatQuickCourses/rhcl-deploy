== Create HTTP Route

This lab guides you through the process of setting up and verifying an HTTPRoute for your Gateway, enforcing DNSPolicy and other policies, creating AWS credentials, and configuring the Gateway for use by multiple namespaces while ensuring that the connection is secure and functioning as expected.

* Create an **HTTPRoute** for your Gateway by running the following command:
+
[subs="+quotes,+macros"]
----
[lab-user@bastion ~]$ **curl -s https://raw.githubusercontent.com/RedHatQuickCourses/rhcl-qc-apps/refs/heads/main/kuadrant-httproute.yaml | envsubst | oc apply -f -**
httproute.gateway.networking.k8s.io/test created
----

* Navigate to the _Red Hat Openshift console_ and select **Operators** -> select **Installed Opertor** -> select **Kuadrant Operator** -> select **DNSPolicy** -> select **external-dnspolicy** and notice the **Conditions** section.
+
image::dns4.png[align="center"]
+
Take note that all DNSPolicy rules are enforced after this step.

* Navigate to the _Red Hat Openshift console_ and select **Operators** -> select **Installed Opertor** -> select **Kuadrant Operator** -> select **All Instances**:
+
image::all.png[align="center"]
+
Take note that the status of all pods shows **Accepted, Enforced**.

* Navigate to the _Red Hat Openshift console_ and select **Operators** -> select **Installed Opertor** -> select **DNS Operator** -> select **DNSRecord**:
+
image::all2.png[align="center"]
+
Take note that the DNS records has been created.

* Refresh all DNS records in AWS and verify that the records have been successfully created.
** Navigate to your AWS account → navigate to **Route 53** → select **Hosted Zones** → select **managed.sandboxXXXX.opentlc.com**.
+
image::dnsrecord.png[align="center"]

* Verify that your Gateway policies are being enforced after appling HTTP route as follows:
+
[subs="+quotes,+macros"]
----
[lab-user@bastion ~]$ oc get dnspolicy ${gatewayName}-dnspolicy -n ${gatewayNS} -o=jsonpath='{.status.conditions[?(@.type=="Enforced")].message}'
DNSPolicy has been successfully enforced

[lab-user@bastion ~]$ oc get authpolicy ${gatewayName}-auth -n ${gatewayNS} -o=jsonpath='{.status.conditions[?(@.type=="Enforced")].message}'
AuthPolicy has been successfully enforced

[lab-user@bastion ~]$ oc get ratelimitpolicy ${gatewayName}-rlp -n ${gatewayNS} -o=jsonpath='{.status.conditions[?(@.type=="Enforced")].message}'
RateLimitPolicy has been successfully enforced
----

* Create **aws-credentials** secret under **cert-manager** namespace for **AWS_ACCESS_KEY_ID** and **AWS_SECRET_ACCESS_KEY**:
+
[subs="+quotes,+macros"]
----
[lab-user@bastion ~]$ oc -n cert-manager create secret generic aws-credentials --type=kuadrant.io/aws --from-literal=AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID --from-literal=AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
secret/aws-credentials created
----

* Delete the existing pod to ensure that the secret propagates into the pods.
Navigate to _Red Hat Openshift console_, select **Workloads** → select **Pods** → select **Project: cert-manager** → choose cert-manager-XXXXX and delete it:
+
image::pod.png[align="center"]
+
Allow the pod to recreate itself and then wait for 5 minutes for the secrets to propograte in the pod.

* Test connectivity and deny all auth.
** You can use curl to hit your endpoint. You should see a 403. Because this example uses Let's Encrypt staging, you can pass the -k flag:
+
[subs="+quotes,+macros"]
----
[lab-user@bastion ~]$ curl -k -w "%{http_code}" https://$(oc get httproute test -n ${gatewayNS} -o=jsonpath='{.spec.hostnames[0]}')
403
----
+
Above command can take 5-10 mins to return result.

* Verify that your listener is ready:
+
[subs="+quotes,+macros"]
----
[lab-user@bastion ~]$ oc get gateway ${gatewayName} -n ${gatewayNS} -o=jsonpath='{.status.listeners[0].conditions[?(@.type=="Programmed")].message}'
No errors found
----

* Open up the Gateway for other namespaces
** Because you have configured the Gateway, secured it with Kuadrant policies, and tested it, you can now open it up for use by other teams in other namespaces:
+
[subs="+quotes,+macros"]
----
[lab-user@bastion ~]$ oc patch gateway ${gatewayName} -n ${gatewayNS} --type='json' -p='[{"op": "replace", "path": "/spec/listeners/0/allowedRoutes/namespaces/from", "value":"All"}]'
gateway.gateway.networking.k8s.io/external patched
----
